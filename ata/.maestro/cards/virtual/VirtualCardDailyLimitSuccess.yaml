appId: com.nymcard.masaar

env:
  PASSCODE: "888555"

tags:
  - cards
  - card_limit
  - virtual_card

---
# Loading element definitions for cards
- runFlow:
    label: Load element definitions for cards
    commands:
      - runScript:
          file: ../../elements/cards.js

# Run login flow from "LoginSuccess.yaml"
- runFlow:
    file: ../../auth/login/LoginSuccess.yaml
    env:
      PHONE: "508655686"
      PASSCODE: "888555"

- assertVisible:
    label: Verify My Card tile visible on Home screen
    id: ${output.cards.homeCardTile}

- tapOn:
    label: Tap card tile to navigate to card details screen
    id: ${output.cards.homeCardTile}

- assertNotVisible:
    label: Confirm card is virtual by checking chip/NFC not present
    id: ${output.cards.cardChipAndNFC}

- assertVisible:
    label: Verify card is active and not inactive
    id: ${output.cards.cardStatePresent}

- assertVisible:
    label: Verify Card limits button visible
    id: ${output.cards.limitsButton}

- tapOn:
    label: Tap Card limits button to open transaction limits screen
    id: ${output.cards.limitsButton}

- assertVisible:
    label: Verify Transaction limits screen title visible
    id: ${output.cardTransactionLimits.transactionLimitTitle}

- assertVisible:
    label: Verify Ecommerce transaction limit option visible
    id: ${output.cardTransactionLimits.ecommerceTransactionLimit}

- tapOn:
    label: Tap Ecommerce transaction limit option
    id: ${output.cardTransactionLimits.ecommerceTransactionLimit}

- assertVisible:
    label: Verify Daily limit option visible
    id: ${output.cardTransactionLimits.dailyLimit}

- assertVisible:
    label: Verify update limit icon visible
    id: ${output.cardTransactionLimits.dailyUpdateLimitIcon}

- tapOn:
    label: Tap update limit icon to open limit editor
    id: ${output.cardTransactionLimits.dailyUpdateLimitIcon}

- assertVisible:
    label: Verify update limit sheet visible
    id: ${output.cardTransactionLimits.updateLimitSheet}

- assertVisible:
    label: Verify current limit value displayed
    id: ${output.cardTransactionLimits.currentLimitValue}

- assertVisible:
    label: Verify save limit button visible
    id: ${output.cardTransactionLimits.saveLimit}

- assertVisible:
    label: Verify decrease limit button visible
    id: ${output.cardTransactionLimits.decreaseLimit}

- assertVisible:
    label: Verify increase limit button visible
    id: ${output.cardTransactionLimits.increaseLimit}

# Read the maximum allowed limit from the UI and convert it to a numeric value
- copyTextFrom:
    label: Copy maximum allowed limit value
    id: ${output.cardTransactionLimits.allowedLimit}

# Storing the allowed limit in variable by convert it to a numeric value
- evalScript: ${output.allowedLimit = Number(maestro.copiedText.replace(/[^0-9.]/g, ""))}

# Read the current limit value from the UI and convert it to a numeric value
- copyTextFrom:
    label: Copy current limit value
    id: ${output.cardTransactionLimits.currentLimitValue}

# Storing the old limit in variable by convert it to a numeric value
- evalScript: ${output.oldValue = Number(maestro.copiedText.replace(/[^0-9.]/g, ""))}

# Decide whether we should increase or decrease the limit based on current vs allowed values
- evalScript: ${
    const current = output.oldValue;
    const allowed = output.allowedLimit;
    const minLimit = 1000;

    if (current >= allowed) {
        output.action = "DECREASE";
    }

    else if (current <= 1000) {
        output.action = "INCREASE";
    }

    else {
        output.action = "DECREASE";
    }}

# If we decided to decrease the limit, tap on the decrease button
- runFlow:
    when:
      true: ${output.action === "DECREASE"}
    commands:
      - tapOn:
          id: ${output.cardTransactionLimits.decreaseLimit}

# If we decided to increase the limit, tap on the increase button
- runFlow:
    when:
      true: ${output.action === "INCREASE"}
    commands:
      - tapOn:
          id: ${output.cardTransactionLimits.increaseLimit}

# Read the updated limit value from the UI and convert it to a numeric value
- copyTextFrom:
    label: Copy updated limit value
    id: ${output.cardTransactionLimits.currentLimitValue}

# Storing the new limit in variable by convert it to a numeric value
- evalScript: ${output.newValue = Number(maestro.copiedText.replace(/[^0-9.]/g, ""))}

# If the new limit value is different from the old one, save the updated limit
- runFlow:
    when:
      true: ${output.newValue !== output.oldValue}
    commands:
      - tapOn:
          id: ${output.cardTransactionLimits.saveLimit}

- assertVisible:
    label: Verify Passcode verification screen visible
    id: ${output.login.codeField}

- tapOn:
    label: Focus passcode input field
    id: ${output.login.codeField}

- inputText:
    label: Enter valid passcode
    text: ${PASSCODE}

- hideKeyboard:
    label: Hide keyboard after passcode entry

- tapOn:
    label: Submit passcode to confirm limit update
    id: ${output.login.continueButton}

- assertVisible:
    label: Verify daily limit update success confirmation visible
    id: ${output.cardTransactionLimits.limitUpdateSuccess}

# Capture platform-specific screenshots
- runFlow:
    label: Take Android limit update success screenshot
    when:
      platform: android
    commands:
      - takeScreenshot: VirtualCardDailyLimitUpdatedSuccessAndroid

- runFlow:
    label: Take iOS limit update success screenshot
    when:
      platform: ios
    commands:
      - takeScreenshot: VirtualCardDailyLimitUpdatedSuccessIOS
